<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nacos 服务管理平台（官方 API 版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1890ff',
                        secondary: '#8c8c8c',
                        success: '#52c41a',
                        warning: '#faad14',
                        danger: '#ff4d4f',
                        nacos: '#2687ff'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .card-shadow { box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.08); }
            .table-hover-row tr:hover { background-color: #f5f7fa; }
            .namespace-name { font-weight: 600; color: #2687ff; }
            .namespace-id { font-size: 0.85em; color: #8c8c8c; }
            .sortable-header { cursor: pointer; user-select: none; }
            .sortable-header:hover { color: #2687ff; }
            .sort-icon { font-size: 0.7em; margin-left: 4px; opacity: 0.6; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa-solid fa-server text-nacos text-2xl"></i>
            <h1 class="text-xl font-bold text-gray-800">Nacos 服务管理平台</h1>
        </div>
        <div class="flex items-center space-x-4">
                <span id="connection-status" class="text-sm flex items-center">
                    <i class="fa-solid fa-circle text-gray-400 mr-1"></i>
                    <span>未连接</span>
                </span>
            <button id="refresh-btn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded flex items-center">
                <i class="fa-solid fa-refresh mr-1"></i>
                <span>刷新</span>
            </button>
        </div>
    </div>
</header>

<div class="container mx-auto px-4 py-4">
    <div class="bg-white rounded-lg p-4 card-shadow mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nacos 服务器地址</label>
                <input type="text" id="nacos-server" value=""
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Namespace</label>
                <div class="relative">
                    <select id="namespace-select" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none bg-white">
                        <option value="">加载中...</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                    </div>
                </div>
            </div>
            <div class="flex items-end">
                <button id="save-config" class="bg-nacos hover:bg-nacos/90 text-white px-4 py-2 rounded flex items-center w-full">
                    <i class="fa-solid fa-save mr-1"></i>
                    <span>保存配置并连接</span>
                </button>
            </div>
        </div>
    </div>
</div>

<main class="container mx-auto px-4 pb-10">
    <div class="mb-4 border-b border-gray-200">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="tab-list">
            <li class="mr-2">
                <button id="service-tab" class="inline-block p-4 border-b-2 border-nacos text-nacos rounded-t-lg hover:text-nacos hover:bg-gray-50">
                    <i class="fa-solid fa-list-ul mr-1"></i>服务列表
                </button>
            </li>
            <li class="mr-2">
                <button id="config-tab" class="inline-block p-4 border-b-2 border-transparent text-gray-500 rounded-t-lg hover:text-gray-700 hover:bg-gray-50">
                    <i class="fa-solid fa-file-code mr-1"></i>配置列表
                </button>
            </li>
        </ul>
    </div>

    <div id="service-panel" class="block">
        <div class="bg-white rounded-lg card-shadow mb-6">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fa-solid fa-list-ul text-nacos mr-2"></i>服务列表
                </h2>
                <div class="flex items-center space-x-2">
                    <input type="text" id="service-search" placeholder="输入服务名称实时过滤..."
                           class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                </div>
            </div>
            <div id="services-loading" class="py-10 text-center hidden">
                <i class="fa-solid fa-spinner fa-spin text-xl text-nacos mb-2"></i>
                <p class="text-gray-600">正在加载服务列表...</p>
            </div>
            <div id="services-empty" class="py-10 text-center hidden">
                <i class="fa-solid fa-folder-open text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-500">暂无服务数据</p>
            </div>
            <div id="services-error" class="py-10 text-center hidden">
                <i class="fa-solid fa-exclamation-circle text-4xl text-danger mb-2"></i>
                <p class="text-danger" id="services-error-msg">加载服务列表失败</p>
            </div>
            <div id="services-table-container" class="overflow-x-auto">
                <table class="w-full table-hover-row">
                    <thead>
                    <tr class="bg-gray-50 text-left">
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="name">
                            服务名称<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-name"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="group">
                            分组名称<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-group"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="instanceCount">
                            实例数<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-instanceCount"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="healthyCount">
                            健康实例数<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-healthyCount"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">操作</th>
                    </tr>
                    </thead>
                    <tbody id="services-list">
                    </tbody>
                </table>
            </div>
            <div id="services-pagination" class="p-4 border-t border-gray-100 flex justify-between items-center hidden">
                <div class="text-sm text-gray-600">共 <span id="total-services">0</span> 个服务</div>
                <div class="flex space-x-2">
                    <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>上一页</button>
                    <span id="page-info" class="text-sm px-2">第 1 页 / 共 0 页</span>
                    <button id="next-page" class="px-4 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>下一页</button>
                </div>
            </div>
        </div>
    </div>

    <div id="config-panel" class="hidden">
        <div class="bg-white rounded-lg card-shadow mb-6">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fa-solid fa-file-code text-nacos mr-2"></i>配置列表
                </h2>
                <div class="flex items-center space-x-2">
                    <input type="text" id="config-search" placeholder="输入DataID/Group实时过滤..."
                           class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                </div>
            </div>
            <div id="configs-loading" class="py-10 text-center hidden">
                <i class="fa-solid fa-spinner fa-spin text-xl text-nacos mb-2"></i>
                <p class="text-gray-600">正在加载配置列表...</p>
            </div>
            <div id="configs-empty" class="py-10 text-center hidden">
                <i class="fa-solid fa-file-empty text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-500">暂无配置数据</p>
            </div>
            <div id="configs-error" class="py-10 text-center hidden">
                <i class="fa-solid fa-exclamation-circle text-4xl text-danger mb-2"></i>
                <p class="text-danger" id="configs-error-msg">加载配置列表失败</p>
            </div>
            <div id="configs-table-container" class="overflow-x-auto">
                <table class="w-full table-hover-row">
                    <thead>
                    <tr class="bg-gray-50 text-left">
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="dataId">
                            DataID<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-dataId"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="group">
                            Group<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-configGroup"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="appName">
                            应用名称<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-appName"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b sortable-header" data-sort="lastModifiedTime">
                            最后修改时间<i class="fa-solid fa-sort sort-icon ml-1" id="sort-icon-lastModifiedTime"></i>
                        </th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">操作</th>
                    </tr>
                    </thead>
                    <tbody id="configs-list">
                    </tbody>
                </table>
            </div>
            <div id="configs-pagination" class="p-4 border-t border-gray-100 flex justify-between items-center hidden">
                <div class="text-sm text-gray-600">共 <span id="total-configs">0</span> 个配置</div>
                <div class="flex space-x-2">
                    <button id="config-prev-page" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>上一页</button>
                    <span id="config-page-info" class="text-sm px-2">第 1 页 / 共 0 页</span>
                    <button id="config-next-page" class="px-4 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>下一页</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务实例弹窗 -->
    <div id="instance-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800" id="modal-title">
                    <i class="fa-solid fa-server text-nacos mr-2"></i>服务实例详情
                </h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div id="instances-loading" class="py-10 text-center flex-grow">
                <i class="fa-solid fa-spinner fa-spin text-xl text-nacos mb-2"></i>
                <p class="text-gray-600">正在加载实例信息...</p>
            </div>
            <div id="instances-error" class="py-10 text-center flex-grow hidden">
                <i class="fa-solid fa-exclamation-circle text-4xl text-danger mb-2"></i>
                <p class="text-danger" id="instances-error-msg">加载实例信息失败</p>
            </div>
            <div id="instances-table-container" class="overflow-auto flex-grow">
                <table class="w-full table-hover-row">
                    <thead>
                    <tr class="bg-gray-50 text-left sticky top-0">
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">IP地址</th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">端口</th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">状态</th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">权重</th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">集群</th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">最后操作时间</th>
                        <th class="px-4 py-3 text-sm font-medium text-gray-700 border-b">操作</th>
                    </tr>
                    </thead>
                    <tbody id="instances-list">
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end">
                <button id="close-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">
                    关闭
                </button>
            </div>
        </div>
    </div>
</main>

<footer class="bg-white border-t border-gray-200 py-4 mt-auto">
    <div class="container mx-auto px-4 text-center text-sm text-gray-600">
        <p>Nacos 服务管理平台（基于官方 API） &copy; 2026</p>
    </div>
</footer>

<script>
    let currentPage = 1, pageSize = 100, totalPages = 0, totalServices = 0;
    let currentServiceName = '', currentGroupName = '', namespaceList = [];
    let sortField = '', sortDirection = 'asc', allServices = [];
    let configCurrentPage = 1, configTotalPages = 0, configTotalConfigs = 0;
    let configSortField = '', configSortDirection = 'asc', allConfigs = [];
    const STATE_TOKEN = 'IhyDP9Bv3mMOLNJY6n1QfUbiklAurRZo';
    const OFFLINE_EXPIRE_DAYS = 1;

    const elements = {
        // 基础元素
        serviceTab: document.getElementById('service-tab'),
        configTab: document.getElementById('config-tab'),
        servicePanel: document.getElementById('service-panel'),
        configPanel: document.getElementById('config-panel'),
        nacosServer: document.getElementById('nacos-server'),
        accessToken: document.getElementById('access-token'),
        namespaceSelect: document.getElementById('namespace-select'),
        saveConfig: document.getElementById('save-config'),
        connectionStatus: document.getElementById('connection-status'),
        refreshBtn: document.getElementById('refresh-btn'),

        // 服务列表相关
        servicesLoading: document.getElementById('services-loading'),
        servicesEmpty: document.getElementById('services-empty'),
        servicesError: document.getElementById('services-error'),
        servicesErrorMsg: document.getElementById('services-error-msg'),
        servicesTableContainer: document.getElementById('services-table-container'),
        servicesList: document.getElementById('services-list'),
        totalServices: document.getElementById('total-services'),
        prevPage: document.getElementById('prev-page'),
        nextPage: document.getElementById('next-page'),
        pageInfo: document.getElementById('page-info'),
        servicesPagination: document.getElementById('services-pagination'),
        serviceSearch: document.getElementById('service-search'),

        // 配置列表相关
        configsLoading: document.getElementById('configs-loading'),
        configsEmpty: document.getElementById('configs-empty'),
        configsError: document.getElementById('configs-error'),
        configsErrorMsg: document.getElementById('configs-error-msg'),
        configsTableContainer: document.getElementById('configs-table-container'),
        configsList: document.getElementById('configs-list'),
        totalConfigs: document.getElementById('total-configs'),
        configPrevPage: document.getElementById('config-prev-page'),
        configNextPage: document.getElementById('config-next-page'),
        configPageInfo: document.getElementById('config-page-info'),
        configsPagination: document.getElementById('configs-pagination'),
        configSearch: document.getElementById('config-search'),

        // 服务实例弹窗
        instanceModal: document.getElementById('instance-modal'),
        modalTitle: document.getElementById('modal-title'),
        closeModal: document.getElementById('close-modal'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        instancesLoading: document.getElementById('instances-loading'),
        instancesError: document.getElementById('instances-error'),
        instancesErrorMsg: document.getElementById('instances-error-msg'),
        instancesTableContainer: document.getElementById('instances-table-container'),
        instancesList: document.getElementById('instances-list')
    };

    document.addEventListener('DOMContentLoaded', function() {
        bindEvents();
        loadLocalConfig();
        loadNamespaceList();
        cleanExpiredOfflineInstances();
        const savedServer = localStorage.getItem('nacosServer');
        const savedNamespace = localStorage.getItem('namespaceId');
        if (savedServer && savedNamespace) {
            setTimeout(() => {
                elements.namespaceSelect.value = savedNamespace;
                connectToNacos(true);
            }, 1000);
        }
    });

    function bindEvents() {
        // 基础标签切换
        elements.serviceTab.addEventListener('click', () => switchTab('service'));
        elements.configTab.addEventListener('click', () => switchTab('config'));
        elements.saveConfig.addEventListener('click', () => connectToNacos(false));
        elements.refreshBtn.addEventListener('click', () => {
            currentPage = 1;
            configCurrentPage = 1;
            loadServices();
            loadConfigs();
        });

        // 服务列表分页
        elements.prevPage.addEventListener('click', () => { if (currentPage > 1) { currentPage--; filterAndRenderServices(); } });
        elements.nextPage.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; filterAndRenderServices(); } });

        // 配置列表分页
        elements.configPrevPage.addEventListener('click', () => { if (configCurrentPage > 1) { configCurrentPage--; filterAndRenderConfigs(); } });
        elements.configNextPage.addEventListener('click', () => { if (configCurrentPage < configTotalPages) { configCurrentPage++; filterAndRenderConfigs(); } });

        // 搜索过滤
        elements.serviceSearch.addEventListener('input', filterAndRenderServices);
        elements.configSearch.addEventListener('input', filterAndRenderConfigs);

        // 服务实例弹窗
        elements.closeModal.addEventListener('click', closeInstanceModal);
        elements.closeModalBtn.addEventListener('click', closeInstanceModal);
        elements.instanceModal.addEventListener('click', (e) => { if (e.target === elements.instanceModal) closeInstanceModal(); });

        // Namespace切换
        elements.nacosServer.addEventListener('change', () => {
            localStorage.setItem('nacosServer', elements.nacosServer.value);
            loadNamespaceList();
        });
        elements.namespaceSelect.addEventListener('change', () => {
            localStorage.setItem('namespaceId', elements.namespaceSelect.value);
            configCurrentPage = 1;
            loadConfigs();
        });

        // 通用点击事件委托
        document.addEventListener('click', (e) => {
            // 服务列表排序
            const serviceHeader = e.target.closest('.sortable-header[data-sort^="name"], .sortable-header[data-sort^="group"], .sortable-header[data-sort^="instanceCount"], .sortable-header[data-sort^="healthyCount"]');
            if (serviceHeader) toggleServiceSort(serviceHeader.dataset.sort);

            // 配置列表排序
            const configHeader = e.target.closest('.sortable-header[data-sort^="dataId"], .sortable-header[data-sort^="group"], .sortable-header[data-sort^="appName"], .sortable-header[data-sort^="lastModifiedTime"]');
            if (configHeader) toggleConfigSort(configHeader.dataset.sort);

            // 查看服务实例
            const viewBtn = e.target.closest('.view-instances');
            if (viewBtn) {
                currentServiceName = viewBtn.dataset.service;
                currentGroupName = viewBtn.dataset.group;
                openInstanceModal(currentServiceName, currentGroupName);
            }

            // 跳转Nacos查看配置
            const viewConfigBtn = e.target.closest('.view-config');
            if (viewConfigBtn) {
                const dataId = viewConfigBtn.dataset.dataid;
                const group = viewConfigBtn.dataset.group || 'DEFAULT_GROUP';
                const namespace = elements.namespaceSelect.value || '';
                openNacosConfigDetail(dataId, group, namespace);
            }

            // 跳转Nacos编辑配置
            const editConfigBtn = e.target.closest('.edit-config');
            if (editConfigBtn) {
                const dataId = editConfigBtn.dataset.dataid;
                const group = editConfigBtn.dataset.group || 'DEFAULT_GROUP';
                const namespace = elements.namespaceSelect.value || '';
                openNacosConfigEditor(dataId, group, namespace);
            }
        });
    }

    // 跳转到Nacos官方配置查看页面
    function openNacosConfigDetail(dataId, group, namespace) {
        const nacosBaseUrl = elements.nacosServer.value.replace(/\/$/, '');
        const params = new URLSearchParams({
            serverId: 'center',
            dataId: dataId,
            group: group,
            namespace: namespace,
            edasAppName: '',
            searchDataId: '',
            searchGroup: '',
            pageSize: 10,
            pageNo: 1
        });
        const url = `${nacosBaseUrl}/#/configdetail?${params.toString()}`;
        window.open(url, '_blank'); // 新标签页打开
    }

    // 跳转到Nacos官方配置编辑页面
    function openNacosConfigEditor(dataId, group, namespace) {
        const nacosBaseUrl = elements.nacosServer.value.replace(/\/$/, '');
        const params = new URLSearchParams({
            serverId: 'center',
            dataId: dataId,
            group: group,
            namespace: namespace,
            edasAppName: '',
            edasAppId: '',
            searchDataId: '',
            searchGroup: '',
            pageSize: 10,
            pageNo: 1
        });
        const url = `${nacosBaseUrl}/#/configeditor?${params.toString()}`;
        window.open(url, '_blank'); // 新标签页打开
    }

    function switchTab(type) {
        if (type === 'service') {
            elements.serviceTab.classList.add('border-nacos', 'text-nacos');
            elements.serviceTab.classList.remove('border-transparent', 'text-gray-500');
            elements.configTab.classList.add('border-transparent', 'text-gray-500');
            elements.configTab.classList.remove('border-nacos', 'text-nacos');
            elements.servicePanel.classList.remove('hidden');
            elements.configPanel.classList.add('hidden');
        } else {
            elements.configTab.classList.add('border-nacos', 'text-nacos');
            elements.configTab.classList.remove('border-transparent', 'text-gray-500');
            elements.serviceTab.classList.add('border-transparent', 'text-gray-500');
            elements.serviceTab.classList.remove('border-nacos', 'text-nacos');
            elements.configPanel.classList.remove('hidden');
            elements.servicePanel.classList.add('hidden');
            if (elements.namespaceSelect.value) loadConfigs();
        }
    }

    function loadLocalConfig() {
        const savedServer = localStorage.getItem('nacosServer');
        const savedToken = localStorage.getItem('accessToken');
        if (savedServer) elements.nacosServer.value = savedServer;
        if (savedToken) elements.accessToken.value = savedToken;
    }

    async function loadNamespaceList() {
        const serverUrl = elements.nacosServer.value;
        if (!serverUrl) return;
        try {
            const baseUrl = serverUrl.replace(/\/$/, '');
            const response = await fetch(`${baseUrl}/v1/console/namespaces`, {
                method: 'GET', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                mode: 'cors', credentials: 'same-origin'
            });
            if (!response.ok) throw new Error(`HTTP错误：${response.status}`);
            const result = await response.json();
            if (result && result.code === 200 && Array.isArray(result.data)) {
                namespaceList = result.data;
                renderNamespaceSelect(namespaceList);
            } else fallbackLoadNamespace();
        } catch (error) {
            console.error('加载Namespace失败:', error);
            fallbackLoadNamespace();
        }
    }

    function fallbackLoadNamespace() {
        namespaceList = [
            { "namespace": "", "namespaceShowName": "public（默认命名空间）" },
            { "namespace": "e411ed8d-c4b3-4535-af8b-7559cafdf22d", "namespaceShowName": "lmb-toc-test（测试环境）" }
        ];
        renderNamespaceSelect(namespaceList);
    }

    function renderNamespaceSelect(namespaces) {
        elements.namespaceSelect.innerHTML = '<option value="">请选择Namespace</option>';
        namespaces.forEach(ns => {
            const option = document.createElement('option');
            option.value = ns.namespace || '';
            const displayName = ns.namespaceShowName || '未命名命名空间';
            const displayId = ns.namespace || 'public';
            option.textContent = `${displayName} [${displayId}]`;
            option.dataset.name = displayName;
            option.dataset.id = displayId;
            elements.namespaceSelect.appendChild(option);
        });
        const savedNamespace = localStorage.getItem('namespaceId');
        if (savedNamespace) elements.namespaceSelect.value = savedNamespace;
    }

    function connectToNacos(isAuto) {
        const selectedNamespace = elements.namespaceSelect.value;
        if (!selectedNamespace && !isAuto) {
            alert('请先选择一个Namespace！');
            return;
        }
        localStorage.setItem('nacosServer', elements.nacosServer.value);
        localStorage.setItem('namespaceId', selectedNamespace);
        elements.connectionStatus.innerHTML = `<i class="fa-solid fa-circle text-yellow-500 mr-1"></i><span>${isAuto ? '自动连接中...' : '连接中...'}</span>`;
        currentPage = 1;
        configCurrentPage = 1;
        loadServices();
        loadConfigs();
    }

    // ==================== 服务列表相关函数 ====================
    function toggleServiceSort(field) {
        resetServiceSortIcons();
        if (sortField === field) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        else { sortField = field; sortDirection = 'asc'; }
        updateServiceSortIcon(field);
        filterAndRenderServices();
    }

    function resetServiceSortIcons() {
        ['sort-icon-name', 'sort-icon-group', 'sort-icon-instanceCount', 'sort-icon-healthyCount'].forEach(id => {
            const icon = document.getElementById(id);
            if (icon) { icon.className = 'fa-solid fa-sort sort-icon ml-1'; icon.style.opacity = '0.6'; }
        });
    }

    function updateServiceSortIcon(field) {
        const icon = document.getElementById(`sort-icon-${field}`);
        if (!icon) return;
        icon.className = `fa-solid fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon ml-1`;
        icon.style.opacity = '1';
    }

    function sortServices(services) {
        if (!sortField || !services || services.length === 0) return services;
        return [...services].sort((a, b) => {
            a = a || {}; b = b || {};
            let valueA, valueB;
            switch (sortField) {
                case 'name': valueA = (a.name || '').toLowerCase(); valueB = (b.name || '').toLowerCase(); break;
                case 'group': valueA = (a.groupName || '').toLowerCase(); valueB = (b.groupName || '').toLowerCase(); break;
                case 'instanceCount': valueA = Number(a.ipCount) || 0; valueB = Number(b.ipCount) || 0; break;
                case 'healthyCount': valueA = Number(a.healthyInstanceCount) || 0; valueB = Number(b.healthyInstanceCount) || 0; break;
                default: return 0;
            }
            if (sortDirection === 'asc') {
                return typeof valueA === 'string' ? valueA.localeCompare(valueB) : valueA - valueB;
            } else {
                return typeof valueA === 'string' ? valueB.localeCompare(valueA) : valueB - valueA;
            }
        });
    }

    function filterAndRenderServices() {
        const keyword = elements.serviceSearch.value.trim().toLowerCase();
        let filtered = allServices || [];
        if (keyword) {
            filtered = filtered.filter(s => s && (s.name?.toLowerCase().includes(keyword) || s.groupName?.toLowerCase().includes(keyword)));
        }
        const sorted = sortServices(filtered);
        totalServices = filtered.length;
        totalPages = Math.ceil(totalServices / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        renderServicesList(sorted.slice(start, end));
        updateServicePagination();
        elements.totalServices.textContent = totalServices;
    }

    async function loadServices() {
        const ns = elements.namespaceSelect.value;
        if (!ns) return;
        if (!allServices || allServices.length === 0) elements.servicesLoading.classList.remove('hidden');
        const dataName = elements.namespaceSelect.options[elements.namespaceSelect.selectedIndex].dataset.name;
        const groupName = dataName?.indexOf("iot") > -1 ? 'IOT_GROUP' : 'DEFAULT_GROUP';
        try {
            const baseUrl = elements.nacosServer.value.replace(/\/$/, '');
            const url = `${baseUrl}/v1/ns/service/list?${new URLSearchParams({
                namespaceId: ns, pageNo: 1, pageSize: 1000, serviceNameParam: '', groupName: groupName
            })}`;
            const response = await fetch(url, {
                method: 'GET', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                mode: 'cors', credentials: 'same-origin'
            });
            if (!response.ok) throw new Error(`HTTP错误：${response.status}`);
            const data = await response.json();
            allServices = (data.doms || []).map(name => ({
                name, groupName, ipCount: 0, healthyInstanceCount: 0
            }));
            totalServices = allServices.length;
            totalPages = Math.ceil(totalServices / pageSize);
            elements.connectionStatus.innerHTML = `<i class="fa-solid fa-circle text-success mr-1"></i><span>已连接 (${totalServices} 个服务, ${configTotalConfigs || 0} 个配置)</span>`;
            elements.servicesLoading.classList.add('hidden');
            elements.servicesEmpty.classList.toggle('hidden', allServices.length > 0);
            elements.servicesTableContainer.classList.toggle('hidden', allServices.length === 0);
            elements.servicesPagination.classList.toggle('hidden', allServices.length === 0);
            filterAndRenderServices();
            await loadServicesInstanceCountSilently(allServices, ns);
        } catch (error) {
            console.error('加载服务失败:', error);
            elements.connectionStatus.innerHTML = `<i class="fa-solid fa-circle text-danger mr-1"></i><span>连接失败</span>`;
            elements.servicesLoading.classList.add('hidden');
            elements.servicesError.classList.remove('hidden');
            elements.servicesErrorMsg.textContent = `加载失败：${error.message}`;
        }
    }

    async function loadServicesInstanceCountSilently(services, ns) {
        if (!services || services.length === 0) return;
        const batchSize = 5;
        for (let i = 0; i < services.length; i += batchSize) {
            const batch = services.slice(i, i + batchSize);
            const promises = batch.map(s => new Promise(async resolve => {
                try {
                    const baseUrl = elements.nacosServer.value.replace(/\/$/, '');
                    const url = `${baseUrl}/v1/ns/instance/list?${new URLSearchParams({
                        serviceName: s.name, groupName: s.groupName, namespaceId: ns, healthyOnly: false
                    })}`;
                    const res = await fetch(url, { method: 'GET', mode: 'cors', credentials: 'same-origin' });
                    if (res.ok) {
                        const data = await res.json();
                        const hosts = data.hosts || [];
                        s.ipCount = hosts.length;
                        s.healthyInstanceCount = hosts.filter(h => h.healthy).length;
                        updateServiceInstanceCountSilently(s.name, s.ipCount, s.healthyInstanceCount);
                    }
                } catch (e) { console.error(`加载${s.name}实例数失败:`, e); }
                resolve();
            }));
            await Promise.all(promises);
            await new Promise(r => setTimeout(r, 200));
        }
        filterAndRenderServices();
    }

    function updateServiceInstanceCountSilently(name, total, healthy) {
        const rows = elements.servicesList.querySelectorAll('tr');
        rows.forEach(row => {
            if (row.querySelector('td:first-child')?.textContent.trim() === name) {
                const tds = row.querySelectorAll('td');
                if (tds[2]) tds[2].innerHTML = `<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs">${total}</span>`;
                if (tds[3]) tds[3].innerHTML = `<span class="bg-success/10 text-success px-2 py-1 rounded-full text-xs">${healthy}</span>`;
            }
        });
    }

    function renderServicesList(services) {
        elements.servicesList.innerHTML = '';
        if (!services || services.length === 0) {
            elements.servicesList.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">暂无服务数据</td></tr>';
            return;
        }
        services.forEach(s => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-4 py-3 text-sm">${s.name || '-'}</td>
                <td class="px-4 py-3 text-sm">${s.groupName || 'DEFAULT_GROUP'}</td>
                <td class="px-4 py-3 text-sm"><span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs">${s.ipCount || 0}</span></td>
                <td class="px-4 py-3 text-sm"><span class="bg-success/10 text-success px-2 py-1 rounded-full text-xs">${s.healthyInstanceCount || 0}</span></td>
                <td class="px-4 py-3 text-sm"><button class="view-instances bg-primary/10 hover:bg-primary/20 text-primary px-2 py-1 rounded text-xs flex items-center" data-service="${s.name}" data-group="${s.groupName || 'DEFAULT_GROUP'}"><i class="fa-solid fa-eye mr-1"></i>查看实例</button></td>
            `;
            elements.servicesList.appendChild(tr);
        });
    }

    function updateServicePagination() {
        elements.prevPage.disabled = currentPage <= 1;
        elements.nextPage.disabled = currentPage >= totalPages;
        elements.pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages || 1} 页`;
    }

    // ==================== 服务实例相关函数 ====================
    function saveOfflineInstanceToLocalStorage(data) {
        const { ip, port, serviceName, groupName, clusterName = 'DEFAULT', weight = 1.0 } = data;
        const key = `nacos_offline_instance_${serviceName}_${ip}_${port}`;
        localStorage.setItem(key, JSON.stringify({
            ip, port, serviceName, groupName, clusterName, weight,
            offlineTime: Date.now(),
            expireTime: Date.now() + OFFLINE_EXPIRE_DAYS * 24 * 60 * 60 * 1000
        }));
    }

    function removeOfflineInstanceFromLocalStorage(serviceName, ip, port) {
        localStorage.removeItem(`nacos_offline_instance_${serviceName}_${ip}_${port}`);
    }

    function getOfflineInstancesFromLocalStorage(serviceName) {
        const instances = [];
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('nacos_offline_instance_')) {
                try {
                    const inst = JSON.parse(localStorage.getItem(key) || '{}');
                    if (inst.serviceName === serviceName && inst.expireTime > Date.now()) instances.push(inst);
                } catch (e) { console.error('解析本地实例失败:', e); }
            }
        });
        return instances;
    }

    function cleanExpiredOfflineInstances() {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('nacos_offline_instance_')) {
                try {
                    const inst = JSON.parse(localStorage.getItem(key) || '{}');
                    if (inst.expireTime < Date.now()) localStorage.removeItem(key);
                } catch (e) { localStorage.removeItem(key); }
            }
        });
    }

    window.doInstanceOperation = async function(instance, serviceName, groupName, type) {
        if (!instance || !serviceName) return;
        const { ip, port } = instance;
        const apiUrl = type === 'offline'
            ? `http://${ip}:${port}/actuator/server/shutdown?state=${STATE_TOKEN}`
            : `http://${ip}:${port}/actuator/server/up?state=${STATE_TOKEN}`;
        const btn = document.querySelector(`.${type}-btn[data-ip="${ip}"][data-port="${port}"]`);
        if (btn) { btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-1"></i>处理中...`; }

        try { if (apiUrl) await fetch(apiUrl, { method: 'GET', timeout: type === 'online' ? 10000 : 5000 }); }
        catch (e) { console.log(`${type}请求完成（忽略错误）:`, e); }

        setTimeout(async () => {
            type === 'offline'
                ? saveOfflineInstanceToLocalStorage({ ...instance, serviceName, groupName })
                : removeOfflineInstanceFromLocalStorage(serviceName, ip, port);
            await loadAndRenderInstances(serviceName, groupName);
            await loadServicesInstanceCountSilently(allServices.filter(s => s.name === serviceName), elements.namespaceSelect.value);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = type === 'offline'
                    ? '<i class="fa-solid fa-power-off mr-1"></i>下线'
                    : '<i class="fa-solid fa-power-on mr-1"></i>上线';
            }
        }, 1000);
    };

    async function loadAndRenderInstances(serviceName, groupName) {
        const ns = elements.namespaceSelect.value;
        elements.instancesLoading.classList.remove('hidden');
        elements.instancesError.classList.add('hidden');
        try {
            const baseUrl = elements.nacosServer.value.replace(/\/$/, '');
            const url = `${baseUrl}/v1/ns/instance/list?${new URLSearchParams({
                serviceName, groupName, namespaceId: ns, healthyOnly: false
            })}`;
            const response = await fetch(url, { method: 'GET', mode: 'cors', credentials: 'same-origin' });
            if (!response.ok) throw new Error(`HTTP错误：${response.status}`);
            const data = await response.json();
            const nacosInsts = (data.hosts || []).map(inst => ({ ...inst, source: 'nacos' }));
            const localOffInsts = getOfflineInstancesFromLocalStorage(serviceName);
            const merged = [...nacosInsts];
            localOffInsts.forEach(inst => {
                if (!nacosInsts.some(n => n.ip === inst.ip && n.port === inst.port)) {
                    merged.push({
                        ...inst, healthy: false, registerTime: inst.offlineTime,
                        source: 'local', offlineTime: inst.offlineTime
                    });
                }
            });
            renderInstancesList(merged, serviceName, groupName);
        } catch (error) {
            console.error('加载实例失败:', error);
            elements.instancesError.classList.remove('hidden');
            elements.instancesErrorMsg.textContent = `加载失败：${error.message}`;
        } finally {
            elements.instancesLoading.classList.add('hidden');
        }
    }

    function openInstanceModal(serviceName, groupName) {
        elements.modalTitle.textContent = `服务实例详情 - ${serviceName}`;
        elements.instanceModal.classList.remove('hidden');
        elements.instancesList.innerHTML = '';
        loadAndRenderInstances(serviceName, groupName);
    }

    function closeInstanceModal() {
        elements.instanceModal.classList.add('hidden');
    }

    function renderInstancesList(instances, serviceName, groupName) {
        elements.instancesList.innerHTML = '';
        if (!instances || instances.length === 0) {
            elements.instancesList.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">该服务暂无实例</td></tr>';
            return;
        }
        instances.forEach(inst => {
            const time = inst.registerTime || inst.offlineTime || inst.lastBeat;
            const displayTime = time ? new Date(time).toLocaleString() : '-';
            const isHealthy = inst.healthy === true;
            const statusClass = isHealthy ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger';
            const statusText = isHealthy ? '健康' : '已下线';
            const statusTip = inst.source === 'local' ? '（本地记录，有效期1天）' : '';
            const opBtn = isHealthy ? `
                <button class="offline-btn bg-danger/10 hover:bg-danger/20 text-danger px-2 py-1 rounded text-xs flex items-center" data-ip="${inst.ip}" data-port="${inst.port}" onclick="doInstanceOperation({ip: '${inst.ip}', port: '${inst.port}', clusterName: '${inst.clusterName || 'DEFAULT'}', weight: ${inst.weight || 1.0}}, '${serviceName}', '${groupName}', 'offline')">
                    <i class="fa-solid fa-power-off mr-1"></i>下线
                </button>
            ` : `
                <button class="online-btn bg-success/10 hover:bg-success/20 text-success px-2 py-1 rounded text-xs flex items-center" data-ip="${inst.ip}" data-port="${inst.port}" onclick="doInstanceOperation({ip: '${inst.ip}', port: '${inst.port}', clusterName: '${inst.clusterName || 'DEFAULT'}', weight: ${inst.weight || 1.0}}, '${serviceName}', '${groupName}', 'online')">
                    <i class="fa-solid fa-power-on mr-1"></i>上线
                </button>
            `;
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-4 py-3 text-sm font-medium">${inst.ip || '-'}</td>
                <td class="px-4 py-3 text-sm">${inst.port || '-'}</td>
                <td class="px-4 py-3 text-sm"><span class="${statusClass} px-2 py-1 rounded-full text-xs" title="${statusTip}">${statusText}${statusTip}</span></td>
                <td class="px-4 py-3 text-sm">${inst.weight || 1.0}</td>
                <td class="px-4 py-3 text-sm">${inst.clusterName || 'DEFAULT'}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${displayTime}</td>
                <td class="px-4 py-3 text-sm">${opBtn}</td>
            `;
            elements.instancesList.appendChild(tr);
        });
    }

    // ==================== 配置列表相关函数 ====================
    function toggleConfigSort(field) {
        resetConfigSortIcons();
        if (configSortField === field) configSortDirection = configSortDirection === 'asc' ? 'desc' : 'asc';
        else { configSortField = field; configSortDirection = 'asc'; }
        updateConfigSortIcon(field);
        filterAndRenderConfigs();
    }

    function resetConfigSortIcons() {
        ['sort-icon-dataId', 'sort-icon-configGroup', 'sort-icon-appName', 'sort-icon-lastModifiedTime'].forEach(id => {
            const icon = document.getElementById(id);
            if (icon) { icon.className = 'fa-solid fa-sort sort-icon ml-1'; icon.style.opacity = '0.6'; }
        });
    }

    function updateConfigSortIcon(field) {
        let iconId = field === 'group' ? 'sort-icon-configGroup' : `sort-icon-${field}`;
        const icon = document.getElementById(iconId);
        if (!icon) return;
        icon.className = `fa-solid fa-sort-${configSortDirection === 'asc' ? 'up' : 'down'} sort-icon ml-1`;
        icon.style.opacity = '1';
    }

    function sortConfigs(configs) {
        if (!configSortField || !configs || configs.length === 0) return configs;
        return [...configs].sort((a, b) => {
            a = a || {}; b = b || {};
            let valueA, valueB;
            switch (configSortField) {
                case 'dataId': valueA = (a.dataId || '').toLowerCase(); valueB = (b.dataId || '').toLowerCase(); break;
                case 'group': valueA = (a.group || '').toLowerCase(); valueB = (b.group || '').toLowerCase(); break;
                case 'appName': valueA = (a.appName || '').toLowerCase(); valueB = (b.appName || '').toLowerCase(); break;
                case 'lastModifiedTime': valueA = a.lastModifiedTime || 0; valueB = b.lastModifiedTime || 0; break;
                default: return 0;
            }
            if (configSortDirection === 'asc') {
                return typeof valueA === 'string' ? valueA.localeCompare(valueB) : valueA - valueB;
            } else {
                return typeof valueA === 'string' ? valueB.localeCompare(valueA) : valueB - valueA;
            }
        });
    }

    function filterAndRenderConfigs() {
        const keyword = elements.configSearch.value.trim().toLowerCase();
        let filtered = allConfigs || [];
        if (keyword) {
            filtered = filtered.filter(c => c && (c.dataId?.toLowerCase().includes(keyword) || c.group?.toLowerCase().includes(keyword)));
        }
        const sorted = sortConfigs(filtered);
        configTotalConfigs = filtered.length;
        configTotalPages = Math.ceil(configTotalConfigs / pageSize);
        const start = (configCurrentPage - 1) * pageSize;
        const end = start + pageSize;
        renderConfigsList(sorted.slice(start, end));
        updateConfigPagination();
        elements.totalConfigs.textContent = configTotalConfigs;
        if (elements.connectionStatus.querySelector('.text-success')) {
            elements.connectionStatus.innerHTML = `<i class="fa-solid fa-circle text-success mr-1"></i><span>已连接 (${totalServices} 个服务, ${configTotalConfigs} 个配置)</span>`;
        }
    }

    async function loadConfigs() {
        const ns = elements.namespaceSelect.value;
        if (!ns) return;
        elements.configsLoading.classList.remove('hidden');
        try {
            const baseUrl = elements.nacosServer.value.replace(/\/$/, '');
            const params = new URLSearchParams({
                dataId: '', group: '', appName: '', config_tags: '',
                pageNo: 1, pageSize: 100, tenant: ns, search: 'accurate', username: 'nacos'
            });
            const response = await fetch(`${baseUrl}/v1/cs/configs?${params}`, {
                method: 'GET', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                mode: 'cors', credentials: 'same-origin'
            });
            if (!response.ok) throw new Error(`HTTP错误：${response.status}`);
            const data = await response.json();
            allConfigs = Array.isArray(data) ? data : (data.pageItems || []);
            configTotalConfigs = allConfigs.length;
            configTotalPages = Math.ceil(configTotalConfigs / pageSize);
            elements.configsLoading.classList.add('hidden');
            elements.configsEmpty.classList.toggle('hidden', allConfigs.length > 0);
            elements.configsTableContainer.classList.toggle('hidden', allConfigs.length === 0);
            elements.configsPagination.classList.toggle('hidden', allConfigs.length === 0);
            filterAndRenderConfigs();
        } catch (error) {
            console.error('加载配置失败:', error);
            elements.configsLoading.classList.add('hidden');
            elements.configsError.classList.remove('hidden');
            elements.configsErrorMsg.textContent = `加载失败：${error.message}`;
        }
    }

    function renderConfigsList(configs) {
        elements.configsList.innerHTML = '';
        if (!configs || configs.length === 0) {
            elements.configsList.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">暂无配置数据</td></tr>';
            return;
        }
        configs.forEach(c => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-gray-50';
            const modifiedTime = c.lastModifiedTime
                ? new Date(c.lastModifiedTime).toLocaleString()
                : '-';
            tr.innerHTML = `
                <td class="px-4 py-3 text-sm font-medium">${c.dataId || '-'}</td>
                <td class="px-4 py-3 text-sm">${c.group || 'DEFAULT_GROUP'}</td>
                <td class="px-4 py-3 text-sm">${c.appName || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${modifiedTime}</td>
                <td class="px-4 py-3 text-sm">
                    <div class="flex space-x-2">
                        <button class="view-config bg-primary/10 hover:bg-primary/20 text-primary px-2 py-1 rounded text-xs flex items-center" data-dataid="${c.dataId}" data-group="${c.group || 'DEFAULT_GROUP'}">
                            <i class="fa-solid fa-eye mr-1"></i>查看
                        </button>
                        <button class="edit-config bg-warning/10 hover:bg-warning/20 text-warning px-2 py-1 rounded text-xs flex items-center" data-dataid="${c.dataId}" data-group="${c.group || 'DEFAULT_GROUP'}">
                            <i class="fa-solid fa-pen-to-square mr-1"></i>编辑
                        </button>
                    </div>
                </td>
            `;
            elements.configsList.appendChild(tr);
        });
    }

    function updateConfigPagination() {
        elements.configPrevPage.disabled = configCurrentPage <= 1;
        elements.configNextPage.disabled = configCurrentPage >= configTotalPages;
        elements.configPageInfo.textContent = `第 ${configCurrentPage} 页 / 共 ${configTotalPages || 1} 页`;
    }

    // 全局错误捕获与页面卸载清理
    window.addEventListener('beforeunload', function() {
        // 清理临时状态
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('未处理的Promise异常:', event.reason);
        alert(`系统异常：${event.reason?.message || '未知错误'}，请检查Nacos服务连接或控制台查看详情`);
    });
</script>
</body>
</html>