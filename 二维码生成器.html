<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç å·¥å…·</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --success-color: #2ec4b6;
            --warning-color: #f77f00;
            --danger-color: #d62828;
            --secondary-color: #64748b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --radius: 10px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", "system-ui", "-apple-system", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 16px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .tool-header {
            background-color: #1e293b;
            color: #ffffff;
            padding: 18px 24px;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            letter-spacing: 0.5px;
        }

        .tool-header::before {
            content: "ğŸ“±";
            margin-right: 12px;
            color: var(--success-color);
            font-family: monospace;
        }

        /* ä¼˜åŒ–ï¼šTab æ ‡ç­¾æ æ ·å¼ */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin: 0 24px;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 2px solid transparent;
            margin: 0 4px;
            font-weight: 600;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-main);
            border-bottom-color: var(--border-color);
            background-color: rgba(67, 97, 238, 0.05);
        }

        /* Tab å†…å®¹åŒºåŸŸæ ·å¼ */
        .tab-content {
            display: none;
            padding: 20px 24px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-main);
            resize: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: "Cascadia Code", "Consolas", monospace;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #ffffff;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        textarea {
            min-height: 120px;
            max-height: 200px;
        }

        .search-group {
            margin-bottom: 20px;
        }

        /* è§£ç åŠŸèƒ½æ ·å¼ */
        .decode-group {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background-color: rgba(67, 97, 238, 0.02);
        }

        /* æ‹–æ‹½æ‚¬æµ®æ€ï¼šé«˜äº®è¾¹æ¡†ï¼Œæç¤ºç”¨æˆ·å¯é‡Šæ”¾ */
        .decode-group.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
        }

        /* æ‹–æ‹½ä¸Šä¼ æç¤ºï¼ˆé»˜è®¤éšè—ï¼Œæ‹–æ‹½æ‚¬æµ®æ—¶æ˜¾ç¤ºï¼‰ */
        .drag-tip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
            border-radius: 8px;
            font-size: 14px;
            color: var(--primary-color);
            gap: 8px;
            pointer-events: none;
        }

        .decode-group.drag-over .drag-tip {
            display: flex;
        }

        .drag-tip i {
            font-size: 24px;
        }

        .decode-group h3 {
            color: var(--text-main);
            font-size: 16px;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }

        .decode-btn-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-success {
            background-color: var(--success-color);
            color: #ffffff;
        }

        .btn-success:hover {
            background-color: #25a99f;
            box-shadow: 0 4px 12px rgba(46, 196, 182, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #ffffff;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #ffffff;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
            box-shadow: 0 4px 12px rgba(214, 40, 40, 0.3);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .btn-outline:hover {
            background-color: var(--border-color);
            color: var(--text-main);
        }

        #generateBtn {
            flex: 2;
            background-color: var(--primary-color);
            color: #ffffff;
        }

        #generateBtn:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        #resetBtn {
            flex: 1;
            background-color: var(--secondary-color);
            color: #ffffff;
        }

        #resetBtn:hover {
            background-color: #475569;
        }

        #clearAllBtn {
            flex: 1;
            background-color: var(--danger-color);
            color: #ffffff;
        }

        #clearAllBtn:hover {
            background-color: #b91c1c;
            box-shadow: 0 4px 12px rgba(214, 40, 40, 0.3);
        }

        #uploadBtn {
            flex: 1;
            background-color: var(--primary-color);
            color: #ffffff;
        }

        #uploadBtn:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        #pasteBtn {
            flex: 1;
            background-color: var(--success-color);
            color: #ffffff;
        }

        #pasteBtn:hover {
            background-color: #25a99f;
            box-shadow: 0 4px 12px rgba(46, 196, 182, 0.3);
        }

        #copyDecodeResult {
            margin-top: 12px;
            background-color: var(--secondary-color);
            color: #ffffff;
            width: 100%;
        }

        #copyDecodeResult:hover {
            background-color: #475569;
        }

        #decodeResult {
            width: 100%;
            min-height: 100px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 12px;
            background-color: #f8fafc;
            color: var(--text-main);
            font-size: 14px;
            white-space: pre-line;
            word-break: break-all;
            font-family: "Cascadia Code", "Consolas", monospace;
        }

        .decode-tip {
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        /* äºŒç»´ç ç½‘æ ¼å¸ƒå±€ */
        .qrcodes-wrap {
            width: 100%;
            margin-top: 20px;
        }

        .qrcodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
            padding: 16px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background-color: rgba(67, 97, 238, 0.02);
        }

        /* äºŒç»´ç å¡ç‰‡æ ·å¼ */
        .qrcode-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            border: 1px solid var(--border-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .qrcode-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .qrcode-card .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--border-color);
            color: var(--text-muted);
            border: none;
            padding: 0;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .qrcode-card .close-btn:hover {
            background-color: var(--danger-color);
            color: #ffffff;
            transform: scale(1.1);
        }

        .qrcode-card .qrcode-img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 8px;
            max-height: 160px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* å†…å®¹æè¿° */
        .qrcode-card .qrcode-desc {
            font-size: 12px;
            color: var(--text-main);
            text-align: center;
            word-break: break-all;
            white-space: pre-line;
            max-width: 100%;
            padding: 0 4px;
            line-height: 1.3;
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* æ—¶é—´æ ·å¼ */
        .qrcode-card .qrcode-time {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 6px;
        }

        .qrcode-card .qrcode-full-desc {
            font-size: 11px;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .qrcode-card .qrcode-full-desc:hover {
            text-decoration: underline;
            color: var(--primary-hover);
        }

        /* å®Œæ•´å†…å®¹å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--border-color);
            animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal h3 {
            color: var(--text-main);
            margin-bottom: 16px;
            font-size: 16px;
            text-align: center;
            font-weight: 600;
        }

        .modal .full-content {
            font-size: 14px;
            color: var(--text-main);
            line-height: 1.6;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            white-space: pre-line;
            word-break: break-all;
            margin-bottom: 16px;
            background-color: #f8fafc;
            font-family: "Cascadia Code", "Consolas", monospace;
        }

        /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
        .modal .copy-btn {
            background-color: var(--primary-color);
            color: #ffffff;
            width: 100%;
            margin-bottom: 12px;
        }

        .modal .copy-btn:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        /* å¤åˆ¶æˆåŠŸæç¤ºæ ·å¼ */
        .modal .copy-tip {
            text-align: center;
            color: var(--success-color);
            font-size: 12px;
            margin-bottom: 12px;
            display: none;
            font-weight: 600;
        }

        .modal .close-modal {
            background-color: var(--secondary-color);
            color: #ffffff;
            width: 100%;
        }

        .modal .close-modal:hover {
            background-color: #475569;
        }

        .empty-tip, .search-empty-tip {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
        }
    </style>
    <!-- å¼•å…¥å›¾æ ‡åº“ï¼ˆç”¨äºæ‹–æ‹½æç¤ºå›¾æ ‡ï¼Œå¢å¼ºè§†è§‰ä½“éªŒï¼‰ -->
    <link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body>
    <div class="container">
        <div class="tool-header">äºŒç»´ç å·¥å…·</div>

        <!-- Tab æ ‡ç­¾æ  -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="tab-generate">äºŒç»´ç ç”Ÿæˆ</button>
            <button class="tab-btn" data-tab="tab-decode">äºŒç»´ç è§£ç </button>
        </div>

        <!-- Tab 1ï¼šäºŒç»´ç ç”Ÿæˆï¼ˆåŸæœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œé»˜è®¤æ˜¾ç¤ºï¼‰ -->
        <div class="tab-content active" id="tab-generate">
            <div class="form-group">
                <label for="content">äºŒç»´ç å†…å®¹ï¼ˆæ”¯æŒæ–‡æœ¬ã€ç½‘å€ã€æ‰‹æœºå·ã€é‚®ç®±ç­‰ï¼‰</label>
                <textarea id="content" placeholder="è¯·è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šhttps://www.example.com æˆ– 13812345678"></textarea>
            </div>

            <div class="search-group">
                <label for="searchInput">æœç´¢äºŒç»´ç å†…å®¹ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰</label>
                <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢å†å²äºŒç»´ç ...">
            </div>

            <div class="btn-group">
                <button id="generateBtn" class="btn-primary">
                    <i class="fa fa-qrcode"></i>ç”Ÿæˆå¹¶æ·»åŠ äºŒç»´ç 
                </button>
                <button id="resetBtn" class="btn-secondary">
                    <i class="fa fa-refresh"></i>é‡ç½®è¡¨å•
                </button>
                <button id="clearAllBtn" class="btn-danger">
                    <i class="fa fa-trash"></i>æ¸…ç©ºæ‰€æœ‰
                </button>
            </div>

            <div class="qrcodes-wrap">
                <div id="qrcodesGrid" class="qrcodes-grid">
                    <div class="empty-tip">æš‚æ— ç”Ÿæˆçš„äºŒç»´ç ï¼Œè¾“å…¥å†…å®¹åç‚¹å‡»ç”ŸæˆæŒ‰é’®å³å¯æ·»åŠ </div>
                </div>
            </div>
        </div>

        <!-- Tab 2ï¼šäºŒç»´ç è§£ç ï¼ˆç‹¬ç«‹åˆ†ç¦»ï¼Œæ–°å¢æ‹–æ‹½ä¸Šä¼ ï¼‰ -->
        <div class="tab-content" id="tab-decode">
            <div class="decode-group" id="decodeDropArea">
                <!-- æ‹–æ‹½ä¸Šä¼ æç¤ºï¼ˆæ–°å¢ï¼‰ -->
                <div class="drag-tip">
                    <i class="fa fa-cloud-upload"></i>
                    <span>é‡Šæ”¾å›¾ç‰‡å³å¯å®Œæˆä¸Šä¼ è§£æ</span>
                </div>

                <h3>äºŒç»´ç è§£ç åŠŸèƒ½ï¼ˆæ”¯æŒä¸Šä¼ /ç²˜è´´/æ‹–æ‹½ï¼‰</h3>
                <div class="decode-btn-group">
                    <button id="uploadBtn" class="btn-primary">
                        <i class="fa fa-upload"></i>ä¸Šä¼ è§£æ
                    </button>
                    <button id="pasteBtn" class="btn-success">
                        <i class="fa fa-paste"></i>ç²˜è´´è§£æ
                    </button>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <label for="decodeResult">è§£ç ç»“æœï¼š</label>
                <div id="decodeResult"></div>
                <button id="copyDecodeResult" class="btn-secondary">
                    <i class="fa fa-copy"></i>å¤åˆ¶è§£ç ç»“æœ
                </button>
                <div class="decode-tip" id="decodeTip">å¤åˆ¶æˆåŠŸï¼å†…å®¹å·²å­˜å…¥å‰ªè´´æ¿</div>
            </div>
        </div>
    </div>

    <!-- å®Œæ•´å†…å®¹å¼¹çª—ï¼ˆä¿ç•™åŸæœ‰ï¼Œå½’å±ç”ŸæˆåŠŸèƒ½ï¼‰ -->
    <div id="contentModal" class="modal">
        <div class="modal-content">
            <h3>äºŒç»´ç å®Œæ•´åŸå§‹å†…å®¹</h3>
            <div id="fullContent" class="full-content"></div>
            <div id="copyTip" class="copy-tip">å¤åˆ¶æˆåŠŸï¼å†…å®¹å·²å­˜å…¥å‰ªè´´æ¿</div>
            <button class="copy-btn" onclick="copyFullContent()">å¤åˆ¶å®Œæ•´å†…å®¹</button>
            <button class="close-modal" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ–åº“ -->
    <script src="https://jsd.onmicrosoft.cn/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://jsd.onmicrosoft.cn/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // è·å–DOMå…ƒç´ 
        const contentInput = document.getElementById('content');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const qrcodesGrid = document.getElementById('qrcodesGrid');
        const contentModal = document.getElementById('contentModal');
        const fullContent = document.getElementById('fullContent');
        const searchInput = document.getElementById('searchInput');
        const copyTip = document.getElementById('copyTip');
        // è§£ç åŠŸèƒ½DOMå…ƒç´ 
        const uploadBtn = document.getElementById('uploadBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const fileInput = document.getElementById('fileInput');
        const decodeResult = document.getElementById('decodeResult');
        const copyDecodeResult = document.getElementById('copyDecodeResult');
        const decodeTip = document.getElementById('decodeTip');
        // Tab ç›¸å…³DOMå…ƒç´ 
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        // æ‹–æ‹½ä¸Šä¼ æ ¸å¿ƒDOMå…ƒç´ 
        const decodeDropArea = document.getElementById('decodeDropArea');

        // å®šä¹‰localStorageå­˜å‚¨keyï¼Œç»Ÿä¸€ç®¡ç†
        const QR_STORAGE_KEY = 'qrcode_history_records';
        // åˆå§‹åŒ–äºŒç»´ç åºå·ï¼ˆä»æœ¬åœ°å­˜å‚¨è¯»å–ï¼Œä¿è¯åºå·è¿ç»­ï¼‰
        let qrCodeIndex = 1;
        // å›ºå®šäºŒç»´ç å°ºå¯¸
        const DEFAULT_QR_SIZE = 250;
        // æ–°å¢ï¼šæ‹–æ‹½çŠ¶æ€é”ï¼Œé˜²æ­¢é‡å¤è§¦å‘å¯¼è‡´é—ªçƒ
        let isDragging = false;

        // ********** ä¼˜åŒ–ï¼šTab åˆ‡æ¢æ ¸å¿ƒé€»è¾‘ï¼ˆä¿ç•™ï¼Œé€‚é…ç´§å‡‘æ ·å¼ï¼‰ **********
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 1. è·å–å½“å‰è¦åˆ‡æ¢çš„Tab ID
                const targetTab = this.dataset.tab;

                // 2. ç§»é™¤æ‰€æœ‰Tabçš„activeçŠ¶æ€ï¼ˆæŒ‰é’® + å†…å®¹ï¼‰
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // 3. ä¸ºå½“å‰ç‚¹å‡»çš„æŒ‰é’®å’Œå¯¹åº”å†…å®¹æ·»åŠ activeçŠ¶æ€
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´ä¸º YYYY-MM-DD HH:MM:SS
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // ä¼˜åŒ–ï¼šå·¥å…·å‡½æ•° - ç²¾å‡†æå–URLçš„hostå’Œæœ«å°¾å…³é”®å­—ç¬¦
        function formatUrlContent(str) {
            const urlRegex = /^(https?:\/\/)([^\/]+)(.*)$/i;
            if (!urlRegex.test(str)) {
                return str.length > 30 ? str.substring(0, 30) + '...' : str;
            }

            const matchResult = str.match(urlRegex);
            const host = matchResult[2];
            const restContent = matchResult[3];

            const endCharRegex = /([a-zA-Z0-9]+)$/;
            let endChars = '';
            if (endCharRegex.test(restContent)) {
                endChars = restContent.match(endCharRegex)[1];
            } else {
                endChars = restContent.slice(-10);
            }

            return endChars ? `${host}...${endChars}` : host;
        }

        // å·¥å…·å‡½æ•°ï¼šå¤„ç†å†…å®¹å±•ç¤º
        function formatDisplayContent(content) {
            const formattedContent = formatUrlContent(content);
            return formattedContent.length > 35 ? formattedContent.substring(0, 35) + '...' : formattedContent;
        }

        // ********** localStorage æ ¸å¿ƒæ–¹æ³• **********
        function getQRHistoryFromStorage() {
            const historyStr = localStorage.getItem(QR_STORAGE_KEY);
            if (!historyStr) return [];
            
            const history = JSON.parse(historyStr);
            return history.sort((a, b) => {
                return new Date(b.createTime) - new Date(a.createTime);
            });
        }

        function deleteDuplicateQRFromStorage(content) {
            let history = getQRHistoryFromStorage();
            const nonDuplicateHistory = history.filter(record => record.content !== content);
            localStorage.setItem(QR_STORAGE_KEY, JSON.stringify(nonDuplicateHistory));
            qrCodeIndex = nonDuplicateHistory.length > 0 ? Math.max(...nonDuplicateHistory.map(item => item.index)) + 1 : 1;
        }

        function saveQRToStorage(qrRecord) {
            deleteDuplicateQRFromStorage(qrRecord.content);
            const history = getQRHistoryFromStorage();
            history.push(qrRecord);
            localStorage.setItem(QR_STORAGE_KEY, JSON.stringify(history));
            qrCodeIndex = history.length + 1;
        }

        function deleteQRFromStorage(index) {
            let history = getQRHistoryFromStorage();
            history = history.filter(item => item.index !== index);
            localStorage.setItem(QR_STORAGE_KEY, JSON.stringify(history));
            qrCodeIndex = history.length > 0 ? Math.max(...history.map(item => item.index)) + 1 : 1;
        }

        function clearAllQRFromStorage() {
            localStorage.removeItem(QR_STORAGE_KEY);
            qrCodeIndex = 1;
        }

        // ********** å®Œæ•´å†…å®¹å¼¹çª—ç›¸å…³æ–¹æ³• **********
        function openModal(content) {
            fullContent.innerText = unescape(content);
            contentModal.style.display = 'flex';
            copyTip.style.display = 'none';
        }

        function closeModal() {
            contentModal.style.display = 'none';
            fullContent.innerText = '';
            copyTip.style.display = 'none';
        }

        function copyFullContent() {
            const content = fullContent.innerText;
            if (!content) {
                alert('æš‚æ— å¯å¤åˆ¶çš„å†…å®¹ï¼');
                return;
            }

            navigator.clipboard.writeText(content).then(() => {
                copyTip.style.display = 'block';
                setTimeout(() => {
                    copyTip.style.display = 'none';
                }, 3000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥ï¼š', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æˆ–æ£€æŸ¥æµè§ˆå™¨æƒé™ï¼');
            });
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && contentModal.style.display === 'flex') {
                closeModal();
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target === contentModal) {
                closeModal();
            }
        });

        // ********** äºŒç»´ç æ¸²æŸ“ç›¸å…³æ–¹æ³• **********
        function renderQRHistory(filteredHistory = null) {
            const history = filteredHistory 
                ? [...filteredHistory].sort((a, b) => new Date(b.createTime) - new Date(a.createTime))
                : getQRHistoryFromStorage();
            
            if (history.length === 0) {
                const isSearching = searchInput.value.trim() !== '';
                const tipHtml = isSearching 
                    ? '<div class="search-empty-tip">æœªæ‰¾åˆ°åŒ¹é…çš„äºŒç»´ç ï¼Œè¯·æ›´æ¢å…³é”®è¯é‡è¯•</div>'
                    : '<div class="empty-tip">æš‚æ— ç”Ÿæˆçš„äºŒç»´ç ï¼Œè¾“å…¥å†…å®¹åç‚¹å‡»ç”ŸæˆæŒ‰é’®å³å¯æ·»åŠ </div>';
                qrcodesGrid.innerHTML = tipHtml;
                qrCodeIndex = 1;
                return;
            }

            qrcodesGrid.innerHTML = '';
            qrCodeIndex = Math.max(...history.map(item => item.index)) + 1;

            history.forEach(record => {
                const qrCard = document.createElement('div');
                qrCard.className = 'qrcode-card';
                qrCard.dataset.index = record.index;

                const displayContent = formatDisplayContent(record.content);
                qrCard.innerHTML = `
                    <button class="close-btn" onclick="deleteSingleQRCode(this, ${record.index})">Ã—</button>
                    <img class="qrcode-img" src="${record.base64Url}" alt="ç¬¬${record.index}ä¸ªäºŒç»´ç ">
                    <div class="qrcode-desc">${displayContent}</div>
                    <div class="qrcode-time">ç”Ÿæˆæ—¶é—´ï¼š${record.createTime}</div>
                    <div class="qrcode-full-desc" onclick="openModal('${escape(record.content)}')">æŸ¥çœ‹å®Œæ•´å†…å®¹</div>
                `;

                qrcodesGrid.appendChild(qrCard);
            });
        }

        function searchQRCode() {
            const searchKeyword = searchInput.value.trim().toLowerCase();
            const allHistory = getQRHistoryFromStorage();

            if (!searchKeyword) {
                renderQRHistory();
                return;
            }

            const matchedHistory = allHistory.filter(record => 
                record.content.toLowerCase().includes(searchKeyword)
            );

            renderQRHistory(matchedHistory);
        }

        // ********** äºŒç»´ç ç”Ÿæˆç›¸å…³æ–¹æ³• **********
        function generateAndAddQRCode() {
            const content = contentInput.value.trim();

            if (!content) {
                alert('è¯·å…ˆè¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„å†…å®¹ï¼Œä¸èƒ½ä¸ºç©ºï¼');
                contentInput.focus();
                return;
            }

            QRCode.toDataURL(content, {
                width: DEFAULT_QR_SIZE,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, (error, url) => {
                if (error) {
                    console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥ï¼š', error);
                    alert('ç”ŸæˆäºŒç»´ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹æˆ–åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                    return;
                }

                const emptyTip = qrcodesGrid.querySelector('.empty-tip');
                if (emptyTip) {
                    qrcodesGrid.removeChild(emptyTip);
                }

                const now = new Date();
                const qrRecord = {
                    index: qrCodeIndex,
                    content: content,
                    size: DEFAULT_QR_SIZE,
                    base64Url: url,
                    createTime: formatDateTime(now)
                };

                saveQRToStorage(qrRecord);
                searchQRCode();
                contentInput.value = '';
                contentInput.focus();
            });
        }

        function resetForm() {
            contentInput.value = '';
            contentInput.focus();
        }

        function clearAllQRCode() {
            const emptyTip = qrcodesGrid.querySelector('.empty-tip');
            const searchEmptyTip = qrcodesGrid.querySelector('.search-empty-tip');
            if (qrcodesGrid.children.length === 0 || 
                (qrcodesGrid.children.length === 1 && (emptyTip || searchEmptyTip))) {
                alert('å½“å‰æ²¡æœ‰å¯æ¸…ç©ºçš„äºŒç»´ç ï¼');
                return;
            }

            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”Ÿæˆçš„äºŒç»´ç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                qrcodesGrid.innerHTML = '<div class="empty-tip">æš‚æ— ç”Ÿæˆçš„äºŒç»´ç ï¼Œè¾“å…¥å†…å®¹åç‚¹å‡»ç”ŸæˆæŒ‰é’®å³å¯æ·»åŠ </div>';
                clearAllQRFromStorage();
                searchInput.value = '';
            }
        }

        function deleteSingleQRCode(btn, index) {
            const qrCard = btn.parentElement;
            qrcodesGrid.removeChild(qrCard);
            deleteQRFromStorage(index);
            searchQRCode();
        }

        // ********** äºŒç»´ç è§£ç æ ¸å¿ƒåŠŸèƒ½ï¼ˆæ–°å¢æ‹–æ‹½ä¸Šä¼ ï¼‰ **********
        function decodeQRCodeFromImage(imageData) {
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                return code.data;
            } else {
                return null;
            }
        }

        function getImageDataFromFile(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    callback(imageData);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // å¤„ç†æ–‡ä»¶è§£æï¼ˆæŠ½å–å…¬å…±æ–¹æ³•ï¼Œä¾›ä¸Šä¼ æŒ‰é’®å’Œæ‹–æ‹½ä¸Šä¼ å¤ç”¨ï¼‰
        function handleFileDecode(file) {
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            getImageDataFromFile(file, function(imageData) {
                const result = decodeQRCodeFromImage(imageData);
                if (result) {
                    decodeResult.textContent = result;
                } else {
                    decodeResult.textContent = 'æœªèƒ½è¯†åˆ«å‡ºäºŒç»´ç ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æ¸…æ™°ã€å®Œæ•´ï¼';
                }
            });
        }

        function handleUploadDecode() {
            fileInput.click();
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            handleFileDecode(file);
            // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†ï¼Œé¿å…é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶æ— æ³•è§¦å‘changeäº‹ä»¶
            this.value = '';
        });

        async function handlePasteDecode() {
            try {
                // ä¼˜åŒ–1ï¼šç§»é™¤ä¸»åŠ¨æŸ¥è¯¢æƒé™ï¼Œç›´æ¥å°è¯•è¯»å–å‰ªè´´æ¿ï¼Œé¿å…å†—ä½™æç¤º
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            const file = new File([blob], 'qrcode-paste.png', { type: type });
                            handleFileDecode(file);
                            return;
                        }
                    }
                }

                alert('å‰ªè´´æ¿ä¸­æœªæ£€æµ‹åˆ°å›¾ç‰‡ï¼Œè¯·å…ˆå¤åˆ¶äºŒç»´ç å›¾ç‰‡å†å°è¯•ï¼');
            } catch (err) {
                console.error('ç²˜è´´è§£æå¤±è´¥ï¼š', err);
                // ä¼˜åŒ–2ï¼šç»Ÿä¸€å‹å¥½æç¤ºï¼ŒåŒ…å«æƒé™æŒ‡å¼•ï¼Œä¸å†—ä½™
                alert('ç²˜è´´è§£æå¤±è´¥ï¼è¯·å…ˆåœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¼€å¯å‰ªè´´æ¿è¯»å–æƒé™ï¼Œæˆ–å°è¯•ä¸Šä¼ å›¾ç‰‡è§£æã€‚');
            }
        }

        function copyDecodeResultContent() {
            const content = decodeResult.textContent.trim();
            if (!content || content === 'æœªèƒ½è¯†åˆ«å‡ºäºŒç»´ç ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æ¸…æ™°ã€å®Œæ•´ï¼') {
                alert('æš‚æ— æœ‰æ•ˆè§£ç ç»“æœå¯å¤åˆ¶ï¼');
                return;
            }

            navigator.clipboard.writeText(content).then(() => {
                decodeTip.style.display = 'block';
                setTimeout(() => {
                    decodeTip.style.display = 'none';
                }, 3000);
            }).catch(err => {
                console.error('å¤åˆ¶è§£ç ç»“æœå¤±è´¥ï¼š', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
            });
        }

        // ********** æ–°å¢ï¼šæ‹–æ‹½ä¸Šä¼ æ ¸å¿ƒé€»è¾‘ï¼ˆä¼˜åŒ–é—ªçƒé—®é¢˜ï¼‰ **********
        // 1. é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ‹–æ‹½è¡Œä¸ºï¼ˆé¿å…å›¾ç‰‡è¢«æ‰“å¼€ï¼‰
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            decodeDropArea.addEventListener(eventName, preventDefaults, false);
            // ä¼˜åŒ–ï¼šä»…é˜»æ­¢è§£ç åŒºåŸŸçš„é»˜è®¤è¡Œä¸ºï¼Œç§»é™¤document.bodyçš„å…¨å±€ç›‘å¬ï¼Œå‡å°‘å†²çª
            // document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // 2. æ‹–æ‹½è¿›å…¥/æ‚¬æµ®ï¼šæ·»åŠ é«˜äº®æ ·å¼ï¼Œæç¤ºç”¨æˆ·ï¼ˆåŠ é”é˜²æ­¢é‡å¤è§¦å‘ï¼‰
        ['dragenter', 'dragover'].forEach(eventName => {
            decodeDropArea.addEventListener(eventName, () => {
                if (!isDragging) {
                    isDragging = true;
                    highlight();
                }
            }, false);
        });

        // 3. æ‹–æ‹½ç¦»å¼€/é‡Šæ”¾ï¼šç§»é™¤é«˜äº®æ ·å¼ï¼Œæ¢å¤é»˜è®¤çŠ¶æ€ï¼ˆè§£é”é‡ç½®ï¼‰
        ['dragleave', 'drop'].forEach(eventName => {
            decodeDropArea.addEventListener(eventName, () => {
                if (isDragging) {
                    isDragging = false;
                    unhighlight();
                }
            }, false);
        });

        function highlight() {
            decodeDropArea.classList.add('drag-over');
        }

        function unhighlight() {
            decodeDropArea.classList.remove('drag-over');
        }

        // 4. æ‹–æ‹½é‡Šæ”¾ï¼šè·å–æ–‡ä»¶å¹¶è§£æ
        decodeDropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0]; // è·å–æ‹–æ‹½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆä»…æ”¯æŒå•æ–‡ä»¶ï¼‰
            handleFileDecode(file);
        }

        // ********** é¡µé¢åˆå§‹åŒ– **********
        window.onload = function() {
            renderQRHistory();
        };

        // ç»‘å®šäº‹ä»¶
        generateBtn.addEventListener('click', generateAndAddQRCode);
        resetBtn.addEventListener('click', resetForm);
        clearAllBtn.addEventListener('click', clearAllQRCode);
        contentInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateAndAddQRCode();
            }
        });
        searchInput.addEventListener('input', searchQRCode);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchQRCode();
            }
        });
        uploadBtn.addEventListener('click', handleUploadDecode);
        pasteBtn.addEventListener('click', handlePasteDecode);
        copyDecodeResult.addEventListener('click', copyDecodeResultContent);
    </script>
</body>
</html>
